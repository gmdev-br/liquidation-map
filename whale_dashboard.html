<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperliquid Whale Watcher</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --surface: #111827;
            --surface2: #161d2e;
            --border: #1e2d45;
            --text: #d1d9e6;
            --muted: #4b5a72;
            --accent: #3b82f6;
            --green: #22c55e;
            --red: #ef4444;
            --gold: #f59e0b;
            --orange: #f97316;
            --mono: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(180deg, #0d1526 0%, #0b0f1a 100%);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 22px;
        }

        .logo h1 {
            font-size: 17px;
            font-weight: 700;
            color: #fff;
        }

        .logo p {
            font-size: 11px;
            color: var(--muted);
            margin-top: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 7px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 11px;
            color: var(--muted);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted);
            flex-shrink: 0;
        }

        .dot.scanning {
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent);
            animation: pulse 1.2s infinite;
        }

        .dot.done {
            background: var(--green);
            box-shadow: 0 0 6px var(--green);
        }

        .dot.error {
            background: var(--red);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .3
            }
        }

        .btn {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #fff;
            border: none;
            padding: 7px 18px;
            border-radius: 7px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity .2s, transform .1s;
            font-family: inherit;
        }

        .btn:hover {
            opacity: .9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
        }

        /* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
        .controls {
            padding: 12px 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .ctrl {
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .ctrl label {
            font-size: 11px;
            color: var(--muted);
            white-space: nowrap;
        }

        input[type="number"],
        select {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 9px;
            border-radius: 5px;
            font-size: 12px;
            font-family: inherit;
            width: 130px;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .tabs {
            display: flex;
            gap: 3px;
        }

        .tab {
            padding: 4px 11px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid var(--border);
            color: var(--muted);
            background: transparent;
            font-family: inherit;
            transition: all .15s;
        }

        .tab.active {
            background: rgba(59, 130, 246, .12);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-bar {
            height: 2px;
            background: var(--border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            width: 0%;
            transition: width .4s ease;
        }

        /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
        .stats-row {
            display: flex;
            gap: 1px;
            background: var(--border);
            border-bottom: 1px solid var(--border);
        }

        .stat {
            flex: 1;
            background: var(--surface);
            padding: 14px 20px;
            min-width: 140px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-value.blue {
            color: var(--accent);
        }

        .stat-value.green {
            color: var(--green);
        }

        .stat-value.gold {
            color: var(--gold);
        }

        /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        thead tr {
            background: var(--surface2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 10px 14px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--muted);
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            color: var(--text);
        }

        th.sorted {
            color: var(--accent);
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background .1s;
        }

        tbody tr:hover {
            background: var(--surface2);
        }

        td {
            padding: 10px 14px;
            vertical-align: middle;
            white-space: nowrap;
        }

        /* Address cell */
        .addr-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .addr-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .addr-text {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--accent);
        }

        .addr-name {
            font-size: 10px;
            color: var(--muted);
            margin-top: 1px;
        }

        a.addr-link {
            color: inherit;
            text-decoration: none;
        }

        a.addr-link:hover .addr-text {
            text-decoration: underline;
        }

        /* Coin badge */
        .coin-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .coin-badge.long {
            background: rgba(34, 197, 94, .1);
            color: var(--green);
            border: 1px solid rgba(34, 197, 94, .2);
        }

        .coin-badge.short {
            background: rgba(239, 68, 68, .1);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, .2);
        }

        /* Leverage badge */
        .lev-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(249, 115, 22, .1);
            color: var(--orange);
            border: 1px solid rgba(249, 115, 22, .2);
        }

        /* Values */
        .mono {
            font-family: var(--mono);
            font-size: 12px;
        }

        .green {
            color: var(--green);
        }

        .red {
            color: var(--red);
        }

        .muted {
            color: var(--muted);
        }

        /* Distance to liq bar */
        .liq-cell {
            min-width: 140px;
        }

        .liq-bar-wrap {
            background: var(--border);
            border-radius: 3px;
            height: 5px;
            margin-top: 4px;
            overflow: hidden;
        }

        .liq-bar {
            height: 100%;
            border-radius: 3px;
        }

        .liq-bar.safe {
            background: var(--green);
        }

        .liq-bar.warn {
            background: var(--orange);
        }

        .liq-bar.danger {
            background: var(--red);
        }

        .liq-price {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--muted);
        }

        .liq-pct {
            font-size: 11px;
            font-weight: 600;
        }

        /* Loading / empty */
        .empty-cell {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }

        .empty-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Expand row */
        .expand-row td {
            background: #0a0f1c;
            padding: 0;
        }

        .expand-inner {
            padding: 10px 14px 14px 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        /* Coin filter pills */
        .coin-filter {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .coin-pill {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid var(--border);
            color: var(--muted);
            background: transparent;
            font-family: inherit;
            transition: all .15s;
        }

        .coin-pill.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(59, 130, 246, .08);
        }

        .auto-loading {
            text-align: center;
            padding: 12px;
            color: var(--muted);
            font-size: 11px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="logo">
            <div class="logo-icon">üêã</div>
            <div>
                <h1>Whale Watcher</h1>
                <p>Hyperliquid ¬∑ Position Explorer</p>
            </div>
        </div>
        <div class="header-right">
            <div class="status-badge">
                <div class="dot" id="dot"></div>
                <span id="statusText">Ready</span>
            </div>
            <button class="btn" id="scanBtn" onclick="startScan()">üîç Scan Whales</button>
        </div>
    </div>

    <div class="controls">
        <div class="ctrl">
            <label>Min Account ($)</label>
            <input type="number" id="minValue" value="2500000" step="500000" min="0">
        </div>
        <div class="ctrl">
            <label>Coin Filter</label>
            <select id="coinFilter" onchange="renderTable()">
                <option value="">All Coins</option>
            </select>
        </div>
        <div class="ctrl">
            <label>Side</label>
            <select id="sideFilter" onchange="renderTable()">
                <option value="">All</option>
                <option value="long">Long Only</option>
                <option value="short">Short Only</option>
            </select>
        </div>
        <div class="ctrl">
            <label>Sort PnL window</label>
            <div class="tabs">
                <button class="tab active" data-window="allTime" onclick="setWindow(this)">All Time</button>
                <button class="tab" data-window="month" onclick="setWindow(this)">30d</button>
                <button class="tab" data-window="week" onclick="setWindow(this)">7d</button>
                <button class="tab" data-window="day" onclick="setWindow(this)">24h</button>
            </div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="stats-row">
        <div class="stat">
            <div class="stat-label">Whales Found</div>
            <div class="stat-value blue" id="sWhales">‚Äî</div>
        </div>
        <div class="stat">
            <div class="stat-label">Total Positions</div>
            <div class="stat-value" id="sPositions">‚Äî</div>
        </div>
        <div class="stat">
            <div class="stat-label">Total Capital</div>
            <div class="stat-value green" id="sCapital">‚Äî</div>
        </div>
        <div class="stat">
            <div class="stat-label">Total UPNL</div>
            <div class="stat-value" id="sUpnl">‚Äî</div>
        </div>
        <div class="stat">
            <div class="stat-label">Largest Wallet</div>
            <div class="stat-value gold" id="sLargest">‚Äî</div>
        </div>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Address</th>
                    <th id="th-coin" onclick="sortBy('coin')">Coin ‚Üï</th>
                    <th id="th-szi" onclick="sortBy('szi')">Size ‚Üï</th>
                    <th>Leverage</th>
                    <th id="th-positionValue" onclick="sortBy('positionValue')">Value ‚Üï</th>
                    <th id="th-entryPx" onclick="sortBy('entryPx')">Avg Entry ‚Üï</th>
                    <th id="th-unrealizedPnl" onclick="sortBy('unrealizedPnl')">UPNL ‚Üï</th>
                    <th id="th-funding" onclick="sortBy('funding')">Funding ‚Üï</th>
                    <th>Dist. to Liq.</th>
                    <th id="th-accountValue" onclick="sortBy('accountValue')">Acct. Value ‚Üï</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="11" class="empty-cell">
                        <div class="empty-icon">üêã</div>
                        <div>Click <strong>Scan Whales</strong> to load data</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="auto-loading" id="autoLoading">
        <span class="spinner"></span> Loading more whales in background‚Ä¶
    </div>

    <script>
        const INFO_URL = 'https://api.hyperliquid.xyz/info';
        const LEADERBOARD_URL = 'https://stats-data.hyperliquid.xyz/Mainnet/leaderboard';

        // State
        let whaleList = [];       // from leaderboard
        let allRows = [];         // flat: one row per position
        let displayedRows = [];   // after filters
        let sortKey = 'accountValue';
        let sortDir = -1;
        let activeWindow = 'allTime';
        let loadedCount = 0;
        let scanning = false;
        // Rate limit: 1200 weight/min, clearinghouseState = weight 2 ‚Üí max 600 req/min = 10 req/s
        // We use 8 concurrent requests to stay safely under the limit.
        const MAX_CONCURRENCY = 8;
        const RETRY_DELAY_MS = 2000;  // wait 2s on 429 before retry
        let currentPrices = {};   // coin -> mark price

        // Formatting
        const fmt = (n, dec = 0) => {
            const abs = Math.abs(n);
            if (abs >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (abs >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toFixed(dec);
        };
        const fmtUSD = (n) => {
            const sign = n >= 0 ? '+' : '-';
            const abs = Math.abs(n);
            if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(2) + 'M';
            if (abs >= 1e3) return sign + '$' + (abs / 1e3).toFixed(1) + 'K';
            return sign + '$' + abs.toFixed(0);
        };
        const fmtAddr = (a) => `${a.slice(0, 6)}‚Ä¶${a.slice(-4)}`;
        const fmtNum = (n) => new Intl.NumberFormat('en-US').format(n);

        function setStatus(msg, type = 'idle') {
            document.getElementById('statusText').textContent = msg;
            document.getElementById('dot').className = 'dot ' + type;
        }
        function setProgress(pct) {
            document.getElementById('progressFill').style.width = pct + '%';
        }

        function setWindow(el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            activeWindow = el.dataset.window;
            renderTable();
        }

        function sortBy(key) {
            if (sortKey === key) sortDir *= -1;
            else { sortKey = key; sortDir = -1; }
            document.querySelectorAll('th[id^="th-"]').forEach(t => {
                t.classList.remove('sorted');
                t.textContent = t.textContent.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
            });
            const th = document.getElementById('th-' + key);
            if (th) { th.classList.add('sorted'); th.textContent += sortDir === -1 ? ' ‚ñº' : ' ‚ñ≤'; }
            renderTable();
        }

        function getPnlForWindow(leaderRow, window) {
            if (!leaderRow?.windowPerformances) return 0;
            const wp = leaderRow.windowPerformances.find(w => w[0] === window);
            return wp ? parseFloat(wp[1].pnl || 0) : 0;
        }

        async function fetchAllMids() {
            try {
                const resp = await fetch(INFO_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'allMids' })
                });
                currentPrices = await resp.json(); // {BTC: "95000", ETH: "2000", ...}
            } catch (e) { console.warn('Could not fetch prices', e); }
        }

        async function startScan() {
            const minVal = parseFloat(document.getElementById('minValue').value) || 2500000;
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="11" class="empty-cell"><span class="spinner"></span> Fetching leaderboard‚Ä¶</td></tr>`;
            allRows = [];
            loadedCount = 0;

            setStatus('Fetching leaderboard‚Ä¶', 'scanning');
            setProgress(5);

            try {
                // Fetch leaderboard + prices in parallel
                const [lbResp] = await Promise.all([
                    fetch(LEADERBOARD_URL),
                    fetchAllMids()
                ]);
                if (!lbResp.ok) throw new Error(`Leaderboard HTTP ${lbResp.status}`);
                const lbData = await lbResp.json();
                const rows = lbData.leaderboardRows || [];

                // Filter whales by account value
                whaleList = rows
                    .filter(r => parseFloat(r.accountValue) >= minVal)
                    .sort((a, b) => parseFloat(b.accountValue) - parseFloat(a.accountValue));

                setProgress(15);
                setStatus(`Found ${whaleList.length} whales. Loading positions‚Ä¶`, 'scanning');

                // Start the concurrency-limited streaming loader
                scanning = true;
                streamPositions(minVal);

            } catch (e) {
                console.error(e);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="11" class="empty-cell" style="color:var(--red)">Error: ${e.message}</td></tr>`;
                setStatus('Error', 'error');
                document.getElementById('scanBtn').disabled = false;
            }
        }


        // ‚îÄ‚îÄ Concurrency-limited streaming loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Fires MAX_CONCURRENCY requests at a time. As each resolves, the next
        // whale is immediately dispatched ‚Äî keeping the pipeline full without
        // ever exceeding the rate limit. Retries on 429 with exponential backoff.

        async function fetchWithRetry(whale, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const resp = await fetch(INFO_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'clearinghouseState', user: whale.ethAddress })
                    });
                    if (resp.status === 429) {
                        const wait = RETRY_DELAY_MS * Math.pow(2, attempt);
                        console.warn(`Rate limited, retrying in ${wait}ms‚Ä¶`);
                        await new Promise(r => setTimeout(r, wait));
                        continue;
                    }
                    if (!resp.ok) return null;
                    return await resp.json();
                } catch (e) {
                    if (attempt === retries - 1) return null;
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            return null;
        }

        function processState(whale, state) {
            if (!state) return;
            const positions = (state.assetPositions || []).filter(p => parseFloat(p.position.szi) !== 0);
            positions.forEach(p => {
                const pos = p.position;
                const size = parseFloat(pos.szi);
                const markPrice = parseFloat(currentPrices[pos.coin] || pos.entryPx);
                const liqPx = parseFloat(pos.liquidationPx);
                const entryPx = parseFloat(pos.entryPx);
                let distPct = null;
                if (liqPx > 0 && markPrice > 0) {
                    distPct = Math.abs((markPrice - liqPx) / markPrice) * 100;
                }
                allRows.push({
                    address: whale.ethAddress,
                    displayName: whale.displayName,
                    accountValue: parseFloat(whale.accountValue),
                    leaderRow: whale,
                    coin: pos.coin,
                    szi: size,
                    side: size > 0 ? 'long' : 'short',
                    leverageType: pos.leverage?.type || 'cross',
                    leverageValue: pos.leverage?.value || 1,
                    positionValue: parseFloat(pos.positionValue),
                    entryPx: entryPx,
                    markPrice: markPrice,
                    unrealizedPnl: parseFloat(pos.unrealizedPnl),
                    funding: parseFloat(pos.cumFunding?.sinceOpen || 0),
                    liquidationPx: liqPx,
                    distPct: distPct,
                    marginUsed: parseFloat(pos.marginUsed),
                });
            });
        }

        // Throttled UI refresh ‚Äî at most once every 400ms to avoid reflow spam
        let renderPending = false;
        function scheduleRender() {
            if (renderPending) return;
            renderPending = true;
            setTimeout(() => {
                renderPending = false;
                updateStats();
                updateCoinFilter();
                renderTable();
            }, 400);
        }

        async function streamPositions(minVal) {
            document.getElementById('autoLoading').style.display = 'block';
            const queue = [...whaleList];
            let active = 0;
            let done = 0;
            const total = queue.length;

            await new Promise(resolve => {
                function dispatch() {
                    // Fill up to MAX_CONCURRENCY slots
                    while (active < MAX_CONCURRENCY && queue.length > 0) {
                        const whale = queue.shift();
                        active++;
                        fetchWithRetry(whale).then(state => {
                            processState(whale, state);
                            active--;
                            done++;
                            loadedCount = done;
                            const pct = 15 + (done / total) * 80;
                            setProgress(Math.min(pct, 95));
                            setStatus(`Loading ${done}/${total} whales‚Ä¶`, 'scanning');
                            scheduleRender();
                            if (queue.length > 0) {
                                dispatch(); // refill the slot immediately
                            } else if (active === 0) {
                                resolve(); // all done
                            }
                        });
                    }
                }
                dispatch();
            });

            document.getElementById('autoLoading').style.display = 'none';
            // Final render to make sure everything is shown
            updateStats();
            updateCoinFilter();
            renderTable();
            finishScan();
        }

        function finishScan() {
            setProgress(100);
            setStatus(`${allRows.length} positions from ${Math.min(loadedCount, whaleList.length)} whales`, 'done');
            document.getElementById('scanBtn').disabled = false;
            setTimeout(() => setProgress(0), 1500);
        }

        function updateStats() {
            const whalesWithPos = new Set(allRows.map(r => r.address)).size;
            const totalCap = [...new Set(allRows.map(r => r.address))].reduce((s, addr) => {
                const row = allRows.find(r => r.address === addr);
                return s + (row?.accountValue || 0);
            }, 0);
            const totalUpnl = allRows.reduce((s, r) => s + r.unrealizedPnl, 0);

            document.getElementById('sWhales').textContent = fmtNum(whalesWithPos);
            document.getElementById('sPositions').textContent = fmtNum(allRows.length);
            document.getElementById('sCapital').textContent = '$' + fmt(totalCap);
            const upnlEl = document.getElementById('sUpnl');
            upnlEl.textContent = fmtUSD(totalUpnl);
            upnlEl.className = 'stat-value ' + (totalUpnl >= 0 ? 'green' : 'red');
            const largest = Math.max(...allRows.map(r => r.accountValue), 0);
            document.getElementById('sLargest').textContent = '$' + fmt(largest);
        }

        function updateCoinFilter() {
            const coins = [...new Set(allRows.map(r => r.coin))].sort();
            const sel = document.getElementById('coinFilter');
            const current = sel.value;
            sel.innerHTML = '<option value="">All Coins</option>';
            coins.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                if (c === current) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function renderTable() {
            const coinFilter = document.getElementById('coinFilter').value;
            const sideFilter = document.getElementById('sideFilter').value;

            let rows = allRows.filter(r => {
                if (coinFilter && r.coin !== coinFilter) return false;
                if (sideFilter && r.side !== sideFilter) return false;
                return true;
            });

            // Sort
            rows.sort((a, b) => {
                let va, vb;
                if (sortKey === 'coin') {
                    return sortDir * a.coin.localeCompare(b.coin);
                } else if (sortKey === 'funding') {
                    va = a.funding; vb = b.funding;
                } else {
                    va = a[sortKey] ?? 0;
                    vb = b[sortKey] ?? 0;
                }
                return sortDir * (vb - va);
            });

            displayedRows = rows;
            const tbody = document.getElementById('tableBody');

            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="empty-cell"><div class="empty-icon">üîç</div><div>No positions match the current filters.</div></td></tr>`;
                return;
            }

            tbody.innerHTML = rows.map((r, i) => {
                const side = r.side;
                const pnlClass = r.unrealizedPnl >= 0 ? 'green' : 'red';
                const fundClass = r.funding >= 0 ? 'green' : 'red';

                // Leverage label
                const levType = r.leverageType === 'isolated' ? 'Isolated' : 'Cross';
                const levLabel = `${r.leverageValue}x ${levType}`;

                // Distance to liq
                let distHtml = '<span class="muted">‚Äî</span>';
                if (r.distPct !== null) {
                    const pct = r.distPct;
                    const barClass = pct > 30 ? 'safe' : pct > 10 ? 'warn' : 'danger';
                    const barW = Math.min(pct, 100).toFixed(0);
                    const liqStr = r.liquidationPx > 0 ? '$' + r.liquidationPx.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '‚Äî';
                    distHtml = `
                    <div class="liq-cell">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:6px">
                            <span class="liq-pct ${barClass === 'safe' ? 'green' : barClass === 'warn' ? '' : 'red'}" style="${barClass === 'warn' ? 'color:var(--orange)' : ''}">${pct.toFixed(0)}%</span>
                            <span class="liq-price">${liqStr}</span>
                        </div>
                        <div class="liq-bar-wrap"><div class="liq-bar ${barClass}" style="width:${barW}%"></div></div>
                    </div>`;
                }

                // Size display: show absolute value + coin
                const absSzi = Math.abs(r.szi);
                const sziStr = absSzi >= 1 ? absSzi.toFixed(4) : absSzi.toFixed(6);

                return `<tr>
                <td class="muted" style="font-size:11px">${i + 1}</td>
                <td>
                    <div class="addr-cell">
                        <div class="addr-avatar">${(r.displayName || r.address).slice(0, 2).toUpperCase()}</div>
                        <div>
                            <a class="addr-link" href="https://app.hyperliquid.xyz/explorer/address/${r.address}" target="_blank">
                                <div class="addr-text">${fmtAddr(r.address)}${r.displayName ? ' ‚òÖ' : ''}</div>
                            </a>
                            ${r.displayName ? `<div class="addr-name">${r.displayName}</div>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="coin-badge ${side}">${r.coin} ${side === 'long' ? '‚ñ≤' : '‚ñº'}</span>
                </td>
                <td class="mono">${sziStr}</td>
                <td><span class="lev-badge">${levLabel}</span></td>
                <td class="mono">$${fmt(r.positionValue)}</td>
                <td class="mono">$${r.entryPx.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                <td class="mono ${pnlClass}" style="font-weight:600">${fmtUSD(r.unrealizedPnl)}</td>
                <td class="mono ${fundClass}">${fmtUSD(r.funding)}</td>
                <td>${distHtml}</td>
                <td class="mono">$${fmt(r.accountValue)}</td>
            </tr>`;
            }).join('');
        }
    </script>

</body>

</html>